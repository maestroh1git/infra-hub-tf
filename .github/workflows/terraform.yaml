name: Terraform Deploy via Script

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  TERRAFORM_SCRIPT: ./run_terraform.sh
  AWS_REGION: us-east-1

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.6

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Verify script location and permissions
      run: |
        echo "Checking if the script exists and is executable"
        ls -l $TERRAFORM_SCRIPT  # List the file to check permissions
        if [ ! -f "$TERRAFORM_SCRIPT" ]; then
          echo "Error: Script file $TERRAFORM_SCRIPT does not exist."
          exit 1
        fi
        if [ ! -x "$TERRAFORM_SCRIPT" ]; then
          echo "Error: Script file $TERRAFORM_SCRIPT is not executable."
          exit 1
        fi

    - name: Run Terraform script
      run: |
        echo "Running the Terraform script: $TERRAFORM_SCRIPT"
        ./$TERRAFORM_SCRIPT
